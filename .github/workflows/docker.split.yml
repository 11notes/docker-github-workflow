name: split
on:
  workflow_dispatch:

jobs:
  docker:
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        platform: [amd64, arm64, armv7]
        include:
          - platform: amd64
            runner: ubuntu-24.04
          - platform: arm64
            runner: ubuntu-24.04-arm
          - platform: armv7
            runner: ubuntu-24.04-arm

    services:
      registry:
        image: registry:2
        ports:
          - 5000:5000

    permissions:
      contents: read
      packages: write
      attestations: write
      id-token: write

    steps:   
      - name: init / checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          ref: ${{ github.ref_name }}
          fetch-depth: 0

      - name: docker / login to hub
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772
        with:
          username: 11notes
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: github / login to ghcr
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772
        with:
          registry: ghcr.io
          username: 11notes
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: quay / login to quay
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772
        with:
          registry: quay.io
          username: 11notes+github
          password: ${{ secrets.QUAY_TOKEN }}

      - name: docker / setup qemu
        if: ${{ matrix.platform }} == 'armv7'
        uses: docker/setup-qemu-action@05340d1c670183e7caabdb33ae9f1c80fae3b0c2

      - name: docker / setup buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3.11.1
        with:
          driver-opts: network=host
      
      - name: docker / build image locally
        uses: docker/build-push-action@67a2d409c0a876cbe6b11854e3e25193efe4e62d
        with:
          context: .
          file: arch.dockerfile
          push: true
          platforms: linux/${{ matrix.platform }}
          cache-from: type=registry,ref=11notes/github-workflow:buildcache-${{ matrix.platform }}
          cache-to: type=registry,ref=localhost:5000/11notes/github-workflow:buildcache-${{ matrix.platform }},mode=max,compression=zstd,force-compression=true
          build-args: |
            APP_VERSION=13
          tags: |
            docker.io/11notes/github-workflow:latest
            ghcr.io/11notes/github-workflow:latest
            quay.io/11notes/github-workflow:latest

      - name: docker / build image from cache and push to registries
        id: push
        uses: docker/build-push-action@67a2d409c0a876cbe6b11854e3e25193efe4e62d
        with:
          context: .
          file: arch.dockerfile
          push: true
          sbom: true
          provenance: mode=max
          platforms: linux/${{ matrix.platform }}
          cache-from: type=registry,ref=localhost:5000/11notes/github-workflow:buildcache-${{ matrix.platform }}
          cache-to: type=registry,ref=11notes/github-workflow:buildcache-${{ matrix.platform }},mode=max,compression=zstd,force-compression=true
          build-args: |
            APP_VERSION=13
          tags: |
            docker.io/11notes/github-workflow:latest
            ghcr.io/11notes/github-workflow:latest
            quay.io/11notes/github-workflow:latest

      - name: Generate Artifact Attestation
        uses: actions/attest-build-provenance@e8998f949152b193b063cb0ec769d69d929409be # v2.4.0
        with:
          subject-name: docker.io/11notes/github-workflow
          subject-digest: ${{ steps.push.outputs.digest }}
          #push-to-registry: true
      - name: Export digest
        run: |
          mkdir -p ${{ runner.temp }}/digests
          digest="${{ steps.push.outputs.digest }}"
          touch "${{ runner.temp }}/digests/${digest#sha256:}"
      - name: Upload digest
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: digests-linux-${{ matrix.platform }}
          path: ${{ runner.temp }}/digests/*
          if-no-files-found: error
          retention-days: 1

  merge_platform_containers:
    name: Merge Platform Containers
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        registry: [docker.io, ghcr.io, quay.io]

    permissions:
      contents: read
      packages: write
      attestations: write
      id-token: write

    needs: docker

    steps:
      - name: Download Digests
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0.0
        with:
          path: ${{ runner.temp }}/digests
          pattern: digests-*
          merge-multiple: true

      - name: docker / login to hub
        if: ${{ matrix.registry }} == 'docker.io'
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772
        with:
          username: 11notes
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: github / login to ghcr
        if: ${{ matrix.registry }} == 'ghcr.io'
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772
        with:
          registry: ghcr.io
          username: 11notes
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: quay / login to quay
        if: ${{ matrix.registry }} == 'quay.io'
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772
        with:
          registry: quay.io
          username: 11notes+github
          password: ${{ secrets.QUAY_TOKEN }}

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3.11.1

      - name: Get Docker Metadata
        id: meta
        uses: docker/metadata-action@c1e51972afc2121e065aed6d45c65596fe445f3f # v5.8.0
        with:
          images: ${{ matrix.registry }}/11notes/github-workflow
          tags: |
            latest
      - name: Create manifest list and push
        working-directory: ${{ runner.temp }}/digests
        run: |
          docker buildx imagetools create $(jq -cr '.tags | map("-t " + .) | join(" ")' <<< "$DOCKER_METADATA_OUTPUT_JSON") \
            $(printf 'docker.io/11notes/github-workflow@sha256:%s ' *)
      - name: Inspect Image
        run: |
          docker buildx imagetools inspect ${{ matrix.registry }}/11notes/github-workflow:${{ steps.meta.outputs.version }}
